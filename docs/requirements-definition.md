# Tech Shelf 要求定義書

最終更新日: 2025年7月11日

## 1. プロジェクト概要

### 1.1 ビジョン

Tech Shelfは、技術ブログの執筆から電子書籍の出版までをシームレスに行えるプラットフォームです。個人の知識を蓄積し、価値あるコンテンツとして電子書籍化・販売することで、技術者の知識共有と収益化を支援します。

### 1.2 コアバリュー

- **知識の蓄積**: ブログ記事として日々の学びを記録
- **価値の創造**: 蓄積された記事を体系的な電子書籍に変換
- **収益化**: 作成した電子書籍を販売し、知識を収益に変換
- **AI活用**: AIによる電子書籍の自動生成・編集支援

## 2. ユーザーペルソナ

### 2.1 読者（非会員）

- 技術情報を探している開発者
- 無料でブログ記事を閲覧
- 気に入った著者の電子書籍を購入

### 2.2 ブログ執筆者（会員）

- 技術的な知識を共有したい開発者
- ブログ記事を執筆・公開
- 記事への反応を見て、モチベーションを維持

### 2.3 電子書籍著者（会員）

- 体系的な技術書を出版したい開発者
- 既存のブログ記事を活用して電子書籍を作成
- AIを使って新規に電子書籍を生成
- 電子書籍の販売で収益を得る

## 3. 機能要件

### 3.1 ユーザー管理機能

#### 3.1.1 認証・認可

**実装状況**:

- ✅ モック認証によるログイン機能（開発環境）
- ✅ Cookie認証によるセッション管理
- ✅ ユーザー登録・ログイン・ログアウト
- 🔄 Supabase Auth統合（本番環境向け準備中）

- **非会員**
  - ブログ記事の閲覧（無制限）
  - 電子書籍のサンプル閲覧
  - 電子書籍の購入（ゲスト購入可）
- **会員**
  - メールアドレス/ソーシャル認証によるログイン
  - ブログ記事の投稿・編集・削除
  - 電子書籍の作成・編集・販売
  - 購入した電子書籍の閲覧
  - 売上管理・振込申請

### 3.2 ブログ機能

#### 3.2.1 記事閲覧（非会員可）

- 記事一覧表示（最新順、人気順、カテゴリ別）
- 記事詳細表示
- タグ・カテゴリによる絞り込み
- 全文検索
- シリーズ記事の関連表示
- RSS/Atomフィード配信

#### 3.2.2 記事投稿（会員限定）

- **Markdownエディタ**
  - フルMarkdown記法サポート
  - リアルタイムプレビュー（2ペイン表示）
  - シンタックスハイライト
  - ショートカットキー対応
  - 自動保存機能
- **階層構造エディタ**
  - 見出し（H1〜H6）の自動抽出
  - アウトラインペイン表示
  - 見出しクリックでジャンプ
  - 見出しのドラッグ&ドロップで並び替え
  - 折りたたみ可能な階層表示
- **コンテンツ機能**
  - 画像アップロード（ドラッグ&ドロップ対応）
  - コードブロック（言語別ハイライト）
  - 数式対応（KaTeX/MathJax）
  - テーブルエディタ
  - Mermaidダイアグラム
  - 脚注サポート
- **記事管理**
  - 下書き保存
  - 予約投稿
  - シリーズ設定（複数記事をグループ化）
  - タグ・カテゴリ設定

#### 3.2.3 記事管理（会員限定）

- 投稿済み記事の一覧
- 記事の編集・削除
- アクセス統計表示
- コメント管理（将来実装）

### 3.3 電子書籍作成機能（会員限定）

#### 3.3.1 ブログ記事からの書籍化

- **記事選択**
  - 既存記事の選択（複数選択可）
  - 記事の並び替え
  - シリーズ記事の一括選択
- **AI編集支援**
  - 記事間のつながりを分析
  - 章立ての自動提案
  - 導入・まとめの自動生成
  - 記事の結合・分割提案
  - 重複内容の検出・統合

- **手動編集**
  - 章タイトルの編集
  - 内容の追記・修正
  - 図表の追加
  - 目次の編集

#### 3.3.2 AIによる新規書籍生成

- **アウトライン生成**
  - テーマ・キーワード入力
  - 想定読者の設定
  - AIによる章構成の提案
  - アウトラインの編集・承認
- **コンテンツ生成**
  - 各章の内容をAIが生成
  - 段階的な生成（章ごと）
  - 生成内容のレビュー・編集
  - コード例の自動生成
  - 図解の提案

#### 3.3.3 書籍編集機能

- **統合エディタ**
  - Markdownエディタ（デフォルト）
  - WYSIWYGエディタ（切り替え可能）
  - 分割ビュー（エディタ/プレビュー）
  - フルスクリーンモード
- **階層構造管理**
  - 書籍全体のアウトライン表示
  - 章・節・項の階層構造表示
  - ドラッグ&ドロップで章の並び替え
  - 章の分割・結合機能
  - 階層レベルの一括変更
  - 目次の自動生成・更新
- **プレビュー機能**
  - リアルタイムMarkdownプレビュー
  - 書籍形式プレビュー（見開き表示）
  - PDFプレビュー（印刷レイアウト）
  - ePubプレビュー（リフロー確認）
  - モバイルプレビュー
- **編集支援**
  - バージョン管理（自動保存履歴）
  - 変更差分表示
  - コメント機能
  - 共同編集（将来実装）
  - テンプレート機能

### 3.4 電子書籍販売機能（会員限定）

#### 3.4.1 価格設定

- 販売価格の設定（0円〜）
- セール価格の設定
- 期間限定セール
- クーポン発行

#### 3.4.2 販売管理

- 販売状況ダッシュボード
- 売上レポート
- 購入者統計
- レビュー管理

#### 3.4.3 収益管理

- 売上履歴
- 手数料計算（プラットフォーム手数料30%）
- 振込申請
- 源泉徴収票発行

### 3.5 電子書籍閲覧機能

#### 3.5.1 購入前（全ユーザー）

- 書籍詳細ページ
- サンプル閲覧（最初の1章など）
- 目次確認
- レビュー表示

#### 3.5.2 購入後（購入者のみ）

- Webリーダーでの閲覧
- しおり機能
- ハイライト機能
- メモ機能
- 読書進捗の同期
- オフライン閲覧（PWA）

### 3.6 決済機能

#### 3.6.1 支払い方法

- クレジットカード（Stripe）
- デビットカード
- プリペイドカード
- 銀行振込（法人向け）

#### 3.6.2 購入フロー

- カート機能
- ゲスト購入
- 購入履歴
- 領収書発行

## 4. 非機能要件

### 4.1 パフォーマンス

- ページロード時間: 3秒以内
- 検索レスポンス: 1秒以内
- 同時接続数: 1000ユーザー

### 4.2 セキュリティ

- HTTPS通信の強制
- SQLインジェクション対策
- XSS対策
- CSRF対策
- 個人情報の暗号化
- PCI DSS準拠（決済）

### 4.3 可用性

- 稼働率: 99.9%
- 自動バックアップ（日次）
- 災害復旧計画

### 4.4 ユーザビリティ

- レスポンシブデザイン
- アクセシビリティ対応（WCAG 2.1 AA準拠）
- 多言語対応（日本語・英語）

## 5. システム構成

### 5.1 技術スタック

- **フロントエンド**: SvelteKit v2, Svelte 5, TypeScript
- **スタイリング**: Tailwind CSS v4 + Skeleton UI v3
- **エディタ**: CodeMirror 6 / Monaco Editor
- **Markdown処理**: marked / remark / MDsveX
- **数式**: KaTeX / MathJax
- **ダイアグラム**: Mermaid
- **データベース**: PostgreSQL (Supabase)
- **認証**: Supabase Auth
- **決済**: Stripe
- **AI**: OpenAI API / Claude API
- **検索**: MeiliSearch
- **ファイルストレージ**: Supabase Storage
- **ホスティング**: Vercel

### 5.2 外部連携

- **AI API**: OpenAI / Anthropic Claude
- **決済API**: Stripe
- **メール**: SendGrid
- **画像最適化**: Cloudinary

## 6. データモデル

### 6.1 主要エンティティ

#### User（ユーザー）

- 基本情報（名前、メール、アバター）
- 権限（読者/著者/管理者）
- 認証情報

#### BlogPost（ブログ記事）

- 記事情報（タイトル、本文、スラッグ）
- メタ情報（作成日、更新日、公開状態）
- 著者情報
- カテゴリ・タグ
- シリーズ情報

#### Book（電子書籍）

- 書籍情報（タイトル、説明、価格）
- 著者情報
- カテゴリ・難易度
- 生成元（ブログ記事/AI生成）

#### Chapter（章）

- 章情報（タイトル、内容、順序）
- 所属書籍
- 元ブログ記事（該当する場合）

#### Purchase（購入）

- 購入者情報
- 購入書籍
- 決済情報
- 購入日時

#### BookCreationProject（書籍作成プロジェクト）

- プロジェクト名
- 選択したブログ記事
- AI生成設定
- 作成状態

## 7. 画面設計

### 7.1 公開ページ

1. トップページ
2. ブログ一覧
3. ブログ詳細
4. 電子書籍一覧
5. 電子書籍詳細
6. 著者プロフィール

### 7.2 会員ページ

1. ダッシュボード
2. ブログ投稿・編集
   - エディタ画面（3ペイン: エディタ/アウトライン/プレビュー）
   - 記事設定画面
3. 記事管理
   - 記事一覧
   - 下書き一覧
4. 書籍作成ウィザード
   - 記事選択画面
   - 構成編集画面
5. 書籍編集
   - 統合エディタ（エディタ/階層構造/プレビュー）
   - 書籍設定画面
6. 売上管理
7. アカウント設定

### 7.3 管理者ページ

1. ユーザー管理
2. コンテンツ管理
3. 売上統計
4. システム設定

## 8. 開発ロードマップ

### Phase 1: 基盤構築（完了済み）

- ✅ プロジェクトセットアップ
- ✅ 基本的なレイアウト
- ✅ ブログ閲覧機能
- ✅ 電子書籍閲覧機能

### Phase 2: 認証・会員機能（進行中）

- ✅ 会員登録・ログイン（モック認証で実装済み）
- ✅ プロフィール管理
- 🔄 認証システム（Supabase Auth統合準備中）
- ❌ 権限管理の完全実装

### Phase 3: ブログ投稿機能（3週間）

- Markdownエディタ実装
  - CodeMirror 6統合
  - リアルタイムプレビュー
  - 階層構造表示
- 記事投稿・編集
- 画像アップロード
- 下書き・予約投稿
- シリーズ管理

### Phase 4: 電子書籍作成機能（4週間）

- 記事選択UI
- 書籍作成ウィザード
- AI連携（章構成提案）
- 編集エディタ
- プレビュー機能

### Phase 5: AI書籍生成機能（3週間）

- AIプロンプト設計
- アウトライン生成
- コンテンツ生成
- 生成管理UI

### Phase 6: 決済・販売機能（3週間）

- Stripe統合
- 購入フロー
- 売上管理
- 振込処理

### Phase 7: 最適化・公開準備（2週間）

- パフォーマンス最適化
- セキュリティ監査
- 本番環境構築
- 運用ドキュメント作成

## 9. 開発状況サマリー（2025年7月13日更新）

### 完了済み機能

#### 基盤・インフラ

- ✅ 基本的なプロジェクト構造とレイアウト
- ✅ Prismaデータモデル設計とシードデータ
- ✅ PrismaClientのシングルトンインスタンス化（データベース接続問題の解決）
- ✅ Tailwind CSS v4 + Flowbite Svelte の統合（Skeleton UIから移行）

#### 認証・ユーザー管理

- ✅ 認証機能（モック認証：ログイン、登録、ログアウト）
- ✅ プロフィールページ（/profile）
- ✅ Cookie認証によるセッション管理
- ✅ 認証状態のグローバル管理（auth store）

#### ブログ機能

- ✅ ブログ閲覧機能（一覧、詳細、タグフィルタリング）
- ✅ ブログ投稿機能（/blog/create）
  - ✅ Markdownエディタ（CodeMirror 6統合）
  - ✅ リアルタイムプレビュー（2ペイン表示）
  - ✅ 階層構造表示（アウトラインペイン）
  - ✅ ドラッグ&ドロップによる見出し並び替え
  - ✅ 折りたたみ機能
- ✅ ブログ編集機能（/blog/edit/[id]）
  - ✅ 既存記事の編集・更新
  - ✅ 下書き/公開状態の切り替え
  - ✅ 編集権限チェック（作者本人のみ）
- ✅ マイブログページ（/blog/my）
  - ✅ 自分の記事一覧表示
  - ✅ 下書き・公開済みのフィルタリング
- ✅ 画像アップロード機能
  - ✅ ドラッグ&ドロップ対応
  - ✅ Base64形式でのDB保存（BlogImageモデル）
  - ✅ 画像配信エンドポイント（/blog/image/[id]）
- ✅ RSS/Atomフィード配信（/blog/rss.xml, /blog/atom.xml）

#### 電子書籍機能

- ✅ 書籍一覧ページ（/books）
- ✅ 書籍詳細ページ（/books/[id]）
- ✅ 電子書籍リーダー機能（/reader/[bookId]/[chapterId]）
  - ✅ WebReaderコンポーネント
  - ✅ 章ナビゲーション・目次表示
  - ✅ フォントサイズ調整・テーマ切り替え
  - ✅ 読書進捗表示（現在の章/全章数）

#### 書籍プロジェクト機能

- ✅ プロジェクト管理ページ（/book-projects）
- ✅ プロジェクト作成機能（/book-projects/create）
- ✅ プロジェクト詳細・編集ページ（/book-projects/[id]）
  - ✅ ブログ記事の選択・追加・削除・並び替え
  - ✅ 章の作成・管理・記事割り当て
  - ✅ タブベースUI（記事管理/章構成/設定）
  - ✅ ドラッグ&ドロップによる記事並び替え（svelte-dnd-action）
- ✅ 書籍プレビュー機能（/book-projects/[id]/preview）
  - ✅ 書籍化前の構成確認
  - ✅ 章構成と記事の順序表示
  - ✅ 読書体験に近いレイアウト

#### 検索機能

- ✅ 統合検索ページ（/search）
  - ✅ ブログ記事と書籍の横断検索
  - ✅ タイトル、本文、概要、タグでの検索
  - ✅ 検索タイプフィルター（すべて/ブログ/書籍）

#### テスト実装

- ✅ 単体テスト（Vitest）
  - ✅ 認証、ブログ、書籍プロジェクト機能のテスト
  - ✅ Markdownパーサー、バリデーション関数のテスト
- ✅ 統合テスト
  - ✅ APIエンドポイントのテスト
- ✅ E2Eテスト（Playwright）
  - ✅ 認証フロー、ブログ作成、書籍プロジェクト管理

### 開発中/課題

- 🔄 Supabase Auth統合（モック認証から本番認証への移行）
- 🔄 ユーザーデータとPrismaモデルの連携

### 未実装の主要機能

- ❌ 書籍の最終生成機能（PDF/ePub出力）
- ❌ AI書籍生成機能（OpenAI/Claude API統合）
- ❌ 決済機能（Stripe）
- ❌ 高度な検索機能（MeiliSearch統合）
- ❌ 読書進捗の永続化（データベース保存）
- ❌ しおり・ハイライト機能
- ❌ 予約投稿機能
- ❌ シリーズ管理機能
- ❌ コメント機能
- ❌ 売上管理・振込機能
- ❌ 管理画面

## 10. 成功指標（KPI）

### 10.1 ユーザー指標

- 月間アクティブユーザー数（MAU）
- 会員登録率
- 会員のアクティブ率

### 10.2 コンテンツ指標

- 月間投稿記事数
- 月間作成書籍数
- AI生成利用率

### 10.3 ビジネス指標

- 月間売上高
- 平均購入単価
- 著者あたりの平均収益

### 10.4 技術指標

- ページ表示速度
- エラー率
- システム稼働率

## 11. テスト要件

### 11.1 テスト方針

Tech Shelfの品質を確保するため、以下のテスト戦略を採用します：

- **テスト駆動開発（TDD）**: 新機能開発時はテストファーストアプローチを採用
- **継続的インテグレーション（CI）**: プッシュ毎に自動テスト実行
- **コードカバレッジ**: 重要なビジネスロジックは80%以上のカバレッジを維持

### 11.2 テストレベル

#### 11.2.1 単体テスト（Unit Test）

- **対象**: 個々の関数、コンポーネント、APIエンドポイント
- **ツール**: Vitest, Testing Library
- **カバレッジ目標**: 80%以上
- **重点領域**:
  - 認証・認可ロジック
  - ブログ投稿・編集機能
  - 電子書籍作成ロジック
  - 決済処理
  - データ変換・バリデーション

#### 11.2.2 統合テスト（Integration Test）

- **対象**: 複数コンポーネント間の連携、API統合
- **ツール**: Playwright, Vitest
- **重点領域**:
  - ユーザー認証フロー
  - ブログ記事の作成・編集・公開フロー
  - 電子書籍の購入・閲覧フロー
  - 外部API連携（Stripe、OpenAI等）

#### 11.2.3 E2Eテスト（End-to-End Test）

- **対象**: ユーザーシナリオ全体
- **ツール**: Playwright
- **重要シナリオ**:
  - 新規ユーザー登録から初回投稿まで
  - ブログ記事から電子書籍作成まで
  - 電子書籍の購入から閲覧まで
  - 管理者による売上確認

### 11.3 テスト対象機能

#### 11.3.1 認証・認可

- ログイン・ログアウト処理
- セッション管理
- 権限に基づくアクセス制御
- パスワードリセット

#### 11.3.2 ブログ機能

- 記事の作成・編集・削除
- 下書き保存・公開切り替え
- タグ管理
- Markdown処理とプレビュー
- アウトライン生成

#### 11.3.3 電子書籍機能

- 書籍の作成・編集
- 章の並び替え・編集
- プレビュー機能
- 購入処理
- 閲覧権限チェック

#### 11.3.4 決済機能

- 購入フロー
- 決済処理（Stripe統合）
- 購入履歴管理
- 返金処理

### 11.4 パフォーマンステスト

- **ツール**: Lighthouse CI, k6
- **指標**:
  - ページロード時間: 3秒以内
  - API応答時間: 1秒以内
  - 同時接続数: 1000ユーザー

### 11.5 セキュリティテスト

- **脆弱性スキャン**: 定期的な依存関係チェック
- **ペネトレーションテスト**: リリース前実施
- **重点項目**:
  - SQLインジェクション対策
  - XSS対策
  - CSRF対策
  - 認証・認可の適切性

### 11.6 アクセシビリティテスト

- **ツール**: axe-core, Pa11y
- **基準**: WCAG 2.1 AA準拠
- **重点項目**:
  - キーボードナビゲーション
  - スクリーンリーダー対応
  - カラーコントラスト
